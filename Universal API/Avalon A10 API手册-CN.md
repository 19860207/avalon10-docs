# Avalon A10 矿机 API说明手册 v0.3





###                                          版本说明

| 版本号 | 修改日期   | 说明                                                         |
| ------ | ---------- | ------------------------------------------------------------ |
| v0.1   | 2019-8-31  | 创建文档。                                                   |
| v0.2   | 2019-10-12 | 增加新的API说明，并增加使用场景说明和返回数据举例说明。同时增加了本机支持的常用的CGMiner API说明。 |
| v0.3   | 2019-11-08 | 增加对estats的废除说明。                                     |




# 1.   综述

- API命令使用TCP短连接发送和接收。一次命令发送和返回在一个TCP连接中完成。
- API的发送和接收需要单线程执行，不支持并发。
- 必须等待上一条API命令返回结果，才能发起下一个API通信。
- API通信端口为4028。
- 本文所有示例使用linux下的socat命令完成，socat工具的安装方法见附录二。

# 2.   命令说明

## 2.1.  查询版本

| 命令说明                | 查询控制板版本相关信息。                                     |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | version                                                      |
| 举例（使用linux socat） | echo -n "version"   \| socat -t 30 stdio tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 需要查询矿机版本的时候，例如远程升级之前需要先确认原有矿机固件版本或者有其他查看版本的需求，可以调用此API查询。使用此接口可以得到矿机控制板的软件、硬件版本以及运行的CGMiner版本。其中VERSION为固件软件版本，HWTYPE为硬件类型，DNA为全球唯一编号，MAC为MAC地址。 |
| 返回值举例              | STATUS=S,When=18633,Code=22,Msg=CGMiner versions,Description=cgminer 4.11.1\|VERSION,CGMiner=4.11.1,API=3.7,PROD=AvalonMiner 10xx,MODEL=10xx,HWTYPE=MM3v2,SWTYPE=MM320,VERSION=19090589_789f8e9t_965ebdct,DNA=0000000000000000,MAC=aaa5836a0f14,UPAPI=2 |

 

## 2.2.  重启矿机

| 命令说明                | 无条件重启矿机。                                             |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,reboot,0                                           |
| 举例（使用linux socat） | echo -n   "ascset\|0,reboot,0" \| socat -t 30 stdio tcp:192.168.189.135:4028,shut-none   && echo |
| 使用场景                | 1.当对矿机配置了矿池、网络等参数后，需要重启使配置生效。<br />2.当远程关闭了矿机的算力板电源后，需要重新开始挖矿时，需要重启矿机。<br />3. 当矿机升级固件不正常需要重试时，需要先重启矿机再进行升级。 |

 

## 2.3.  LED灯控制

| 命令说明                | 点亮/关闭矿机面板上白色LED。                                 |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,led,1-\<cmd\>                                      |
| 参数说明                | \<cmd\>  0:关灯       1:开灯      255:查询当前LED灯的状态。  |
| 举例（使用linux socat） | echo -n   "ascset\|0,led,1-255" \| socat -t 30 stdio   tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 当需要将在场地中的众多矿机中寻找特定IP的一台或几台矿机时，可以使用点亮LED灯的方式使它们与众不同。点亮LED灯会使矿机的LED灯变成白色，而关闭LED会使矿机的LED灯恢复之前的颜色（点亮白色LED灯之前的颜色）。 |
| 返回结果举例            | 当查询LED是否已经点亮时，返回数据为<br />STATUS=I,When=18798,Code=118,Msg=ASC 0 set info: LED[0],Description=cgminer 4.11.1<br />其中LED[0]表示未点亮，如果为LED[1]表示已经点亮。<br /><br />当配置LED灯状态时，例如点亮LED灯，得到的返回如下：<br />STATUS=S,When=18984,Code=119,Msg=ASC 0 set OK,Description=cgminer 4.11.1 |

 

## 2.4.  配置工作模式

| 命令说明                | 配置或查询矿机的工作模式（重启后生效）。                     |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,workmode,\<mode\>                                  |
| 参数说明                | \<mode\>   0：普通模式，   1：高性能模式      255： 查询工作模式 |
| 举例（使用linux socat） | echo -n   "ascset\|0,workmode,1" \| socat -t 30 stdio   tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 切换矿机的工作模式，例如当需要节约电力的时候，配置为普通模式。当需要高算力的时候，配置为高性能模式。  注意，切换模式后需要重启矿机使新的工作模式生效。 |
| 返回数据举例            | 如配置矿机为高性能模式，得到的返回如下：<br />STATUS=I,When=19189,Code=118,Msg=ASC 0 set info: WORKMODE[1],Description=cgminer 4.11.1<br />其中WORKMODE[1]表示当前已配置为高性能模式，如果配置为普通模式，这里是WORKMODE[0]。<br /><br />当查询工作模式时，返回数据如下：<br />STATUS=I,When=19313,Code=118,Msg=ASC 0 set info: WORKMODE[1],Description=cgminer 4.11.1<br />其中WORKMODE[1]表示当前为高性能模式，如果为普通模式，这里是WORKMODE[0] |

 

## 2.5.  配置矿池信息

| 命令说明                | 配置矿机的矿池（重启后生效）。                               |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,setpool,\<username\>,\<password\>,\<pooladdr\>,\<worker\>,\<workerpasswd\> |
| 参数说明                | \<username\>矿机登录用户名（与web登录相同）<br />\<password\>矿机登录密码（与web登录相同）   <br />\<pooladdr\>配置的矿池地址   <br />\<worker\>配置的矿工名   <br />\<workerpasswd\>矿工密码 |
| 举例（使用linux socat） | 设置矿机使用矿池stratum+[**tcp://btc.ss.poolin.com:443**](tcp://btc.ss.poolin.com:443)   使用矿工名cctrix.001并且密码为123   假设矿机的登录名和密码都是默认的root，root。   <br />echo -n "ascset\|0,setpool,root,root,stratum+[**tcp://btc.ss.poolin.com:443,cctrix.001,123**](tcp://btc.ss.poolin.com:443,cctrix.001,123)" \| socat -t 30 stdio   tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 当需要修改矿机工作的矿池、矿工、以及矿工密码时，需要调用此API完成。注意：配置需要重启矿机后生效。 |
| 返回数据举例            | STATUS=I,When=8337,Code=118,Msg=ASC 0 set info:
pool success set to stratum+tcp://btc.ss.poolin.com:443<br />worker is cctrix.001<br />workerpassword is 123<br />Please reboot miner to make config work.<br />,Description=cgminer 4.11.1 |

 

## 2.6.  关闭HASH电源

| 命令说明                | 关闭HASH电源使矿机进入关机状态，要回到工作状态请使用重启矿机API命令。 |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,hashpower,0                                        |
| 举例（使用linux socat） | echo -n   "ascset\|0,hashpower,0" \| socat -t 30 stdio   tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景 | 如果需要远程关闭矿机，可以使用此接口实现。 注意，使用此接口仅仅关闭了对HASH板的电源输出，而不会关闭控制板和风扇的电力。如果需要重新开启矿机，需要调用reboot接口重新启动矿机。 |
| 返回数据举例 | STATUS=I,When=20159,Code=118,Msg=ASC 0 set info: Power off hash now ...,Description=cgminer 4.11.1 |

## 2.7.  查询HASH电源状态

| 命令说明                | 读取电源状态。                                               |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | ascset\|0,hashpower                                          |
| 结果解析举例            | 发送API得到如下返回：  <br /> STATUS=I,When=1052,Code=118,Msg=ASC   0 set info: **PS[0 1220 1314 140   1839 1308]**,Description=cgminer   4.11.1   <br />在PS字段中有6组数据，各数据含义如下：   <br />0：错误码 ，当前无错误。（详见附录”电源错误码表“）<br />1220：提供给控制板的电压，12.2V。   <br />1314：提供给HASH板的电压，13.14V   <br />140：输出电流 140A   <br />1839：输出功率 1839W   <br />1308：对HASH板输出电源的设定值。 |
| 举例（使用linux socat） | echo -n   "ascset\|0,hashpower" \| socat -t 30 stdio   tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 当需要查询电源状态时，调用此接口。可以读取到电源的输出电压、电流、功率、电源状态（正常或过流等）。 |
| 返回数据举例            | STATUS=I,When=20136,Code=118,Msg=ASC 0 set info: PS[0 1196 1284 230 2953 1284],Description=cgminer 4.11.1 |

 

#  3.  本机支持的常用CGMiner API说明

## 3.1.  查询当前工作矿池

| 命令说明                | 查询工作矿池相关信息。                                       |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | pools                                                        |
| 举例（使用linux socat） | echo -n "pools“ \| socat -t 300 stdio tcp:192.168.193.226:4028,shut-none && echo |
| 使用场景                | 需要查询矿机当前工作的矿池信息时，调用此接口。可以得到矿池地址、矿工名、当前难度、拒绝率等信息，详见下文返回结果示例。 |
| 返回信息举例            | STATUS=S,When=17592,Code=7,Msg=1 Pool(s),Description=cgminer 4.11.1\|POOL=0,URL=stratum+tcp://btc.ss.poolin.com:443,Status=Alive,Priority=0,Quota=1,Long Poll=N,Getworks=654,Accepted=1701,Rejected=2,Works=204480,Discarded=0,Stale=0,Get Failures=0,Remote Failures=0,User=cctrix.001,Last Share Time=17590,Diff1 Shares=209377280,Proxy Type=,Proxy=,Difficulty Accepted=206045184.00000000,Difficulty Rejected=196608.00000000,Difficulty Stale=0.00000000,Last Share Difficulty=131072.00000000,Work Difficulty=131072.00000000,Has Stratum=true,Stratum Active=true,Stratum URL=btc.ss.poolin.com,Stratum Difficulty=131072.00000000,Has Vmask=true,Has GBT=false,Best Share=459832747,Pool Rejected%=0.0953,Pool Stale%=0.0000,Bad Work=0,Current Block Height=599045,Current Block Version=536870912 |

## 3.2.  查询汇总信息

| 命令说明                | 查询工作汇总信息。                                           |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | summary                                                      |
| 举例（使用linux socat） | echo -n "summary"   \| socat -t 30 stdio tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 需要查询矿机工作信息汇总时，调用此接口。可以得到矿机运行时间（Elapsed）、1分钟、5分钟、15分钟的平均算力值，矿池接受和拒绝的工作数量等信息，详细见下文返回信息举例。 |
| 返回信息举例            | SUMMARY,Elapsed=17994,MHS av=51278810.20,MHS 30s=51423478.12,MHS 1m=51209334.97,MHS 5m=51088640.16,MHS 15m=51312058.99,Found Blocks=0,Getworks=669,Accepted=1740,Rejected=2,Hardware Errors=10,Utility=5.80,Discarded=0,Stale=0,Get Failures=0,Local Work=419458,Remote Failures=0,Network Blocks=24,Total MH=921456687985.0000,Work Utility=716041.36,Difficulty Accepted=211156992.00000000,Difficulty Rejected=196608.00000000,Difficulty Stale=0.00000000,Best Share=459832747,Device Hardware%=0.0000,Device Rejected%=0.0916,Pool Rejected%=0.0930,Pool Stale%=0.0000,Last getwork=0 |

##  3.3.  查询矿机详细信息（注意：此接口将废除）

| 命令说明                | 查询矿机当前状态详细信息。注意：此接口将在后续版本中废除，<br />请勿依赖该接口提供的数据进行二次开发 |
| ----------------------- | ------------------------------------------------------------ |
| 命令格式                | estats                                                       |
| 举例（使用linux socat） | echo -n "estats"   \| socat -t 30 stdio tcp:192.168.189.135:4028,shut-none && echo |
| 使用场景                | 需要查询矿机详细工作状态时，调用此接口。可以得到矿机运行时间（Elapsed），工作状态和正在工作的HASH板数量（SYSTEMSTATU），理论算力值（GHSmm），1小时平均算力值（GHSavg），环境温度（Temp），最大芯片温度（TMax），平均芯片温度（TAvg），各风扇转速（Fan1，Fan2），风扇转速百分比（FanR），平均芯片电压（Vo），每块HASH板上的频率配置（SF0， SF1），每块HASH板上每颗芯片的温度（PVT_T0，PVT_T1），每块HASH板上每颗芯片的电压（PVT_V0，PVT_V1）等信息，详细见下文返回信息举例。 |
| 返回信息举例            | STATUS=S,When=6397,Code=70,Msg=CGMiner stats,Description=cgminer 4.11.1\|STATS=0,ID=AVA100,Elapsed=6354,Calls=0,Wait=0.000000,Max=0.000000,Min=99999999.000000,MM ID0=Ver[1066-19101244_fe411a8_71edeca] DNA[020100002c2af618] NETFAIL[0 0 0 0 0 0 0 0] SYSTEMSTATU[Work: In Work, Hash Board: 3 ] Elapsed[6355] MW[1443554 1443536 1443615] LW[4330705] MH[0 2 0] HW[2] DH[0.736%] Temp[25] TMax[74] TAvg[66] Fan1[3671] Fan2[3635] Fan3[3564] Fan4[3623] FanR[55%] Vo[336] PS[0 1217 1279 221 2834 1280] PLL0[510 1002 2072 3142] PLL1[1353 2097 2323 953] PLL2[628 1079 2043 2976] GHSmm[51062.40] GHSavg[50291.83] WU[702568.70] Freq[632.65] Led[0] MGHS[16645.36 16761.64 16884.83] MTmax[74 72 74] MTavg[65 63 66] TA[342] ECHU[512 512 512] ECMM[0] SF0[575 600 625 650] SF1[575 600 625 650] SF2[575 600 625 650] PVT_T0[ 59  58  55  56  60  62  63  62  58  59  62  64  64  62  59  62  66  67  67  67  63  61  64  66  66  66  62  61  65  66  66  64  61  61  65  66  66  63  61  59  63  65  65  63  59  58  62  64  62  61  57  56  60  59  64  67  67  68  68  66  67  69  68  69  70  67  67  70  70  72  71  69  70  73  74  71  73  69  70  72  72  72  72  69  70  72  72  71  72  71  70  71  72  69  71  67  67  70  69  68  70  66  65  68  68  66  66  64  63  66  65  64  63  61] PVT_T1[ 57  55  52  53  58  59  61  60  56  56  60  61  63  62  58  61  63  65  64  63  60  58  63  64  65  62  59  59  62  64  65  63  60  61  65  66  64  63  58  59  62  62  62  61  59  57  61  61  60  61  56  54  57  59  63  63  64  65  65  63  64  68  68  67  68  66  65  68  68  71  70  68  67  72  72  71  71  67  66  69  70  69  69  67  66  69  69  69  69  66  68  69  71  69  68  64  64  66  67  66  67  64  62  65  65  64  63  61  61  64  64  64  64  61] PVT_T2[ 61  59  56  56  61  63  65  63  59  60  64  66  67  65  62  62  67  68  67  66  61  60  66  66  67  65  61  61  65  67  67  66  62  64  67  68  67  67  63  62  67  67  66  65  63  60  64  66  64  63  60  56  58  61  65  67  69  69  69  66  69  71  71  72  71  70  70  73  72  72  73  70  71  73  73  72  72  70  70  73  73  74  73  70  70  73  74  72  73  69  70  72  72  71  71  69  70  72  70  71  70  68  67  69  70  68  67  65  65  68  67  70  68  64] PVT_V0[333 335 336 330 332 331 329 330 331 327 330 330 328 327 327 327 327 327 326 325 328 325 326 326 323 323 324 327 327 327 330 329 331 322 323 322 324 324 325 324 327 325 325 325 327 328 328 329 330 331 331 328 331 333 329 326 325 324 327 328 321 321 324 318 323 323 321 317 321 319 320 318 320 319 320 316 317 319 320 319 322 319 321 320 316 318 319 319 320 322 319 318 320 318 320 319 323 321 324 318 321 322 322 322 323 322 324 324 321 322 323 322 326 328] PVT_V1[328 330 331 330 330 330 326 327 326 327 326 327 330 329 333 323 326 325 326 325 327 325 324 326 328 328 329 325 327 326 325 324 324 330 329 330 329 329 331 327 325 327 324 325 324 327 328 326 333 332 333 334 335 337 333 328 329 323 328 329 328 327 327 319 321 320 319 318 316 311 312 312 315 317 321 314 317 320 323 322 327 320 324 324 325 325 324 323 323 324 324 324 322 319 323 323 316 315 318 321 324 325 327 324 326 322 324 324 325 325 328 323 326 326] PVT_V2[339 340 342 327 328 328 328 329 331 326 326 325 334 334 333 326 325 325 327 327 328 330 330 331 325 325 327 325 324 324 322 321 322 324 323 325 324 325 326 324 325 324 326 326 325 329 330 327 332 331 331 328 329 332 330 327 324 321 323 323 324 322 318 319 318 317 319 319 320 321 321 321 316 317 317 320 322 322 320 318 321 316 320 323 320 323 326 316 317 317 322 321 320 316 317 318 320 322 324 328 328 328 325 322 321 324 324 324 322 322 323 319 322 324] MW0[198 209 215 214 248 223 222 230 211 231 219 230 199 218 188 218 203 226 215 218 226 217 213 246 229 231 208 208 208 199 222 230 226 196 208 193 214 212 210 201 206 219 229 217 197 208 200 214 193 245 215 207 203 212 221 190 209 238 194 240 209 219 213 197 192 186 187 207 216 215 213 241 225 186 209 201 200 226 197 201 235 202 221 201 209 183 218 213 184 196 197 194 187 203 186 229 228 201 196 189 201 210 211 187 215 202 226 208 219 197 217 213 215 230] MW1[212 219 229 202 219 191 204 203 232 214 204 191 200 229 192 234 215 230 207 210 190 200 222 178 219 230 227 226 223 231 232 204 244 221 209 217 245 229 234 207 225 218 197 202 231 214 220 235 230 232 216 206 202 233 215 218 244 224 224 181 191 243 199 213 223 223 195 199 177 185 191 206 182 181 204 197 216 214 208 212 228 226 218 211 218 219 229 213 217 181 221 211 195 200 210 209 197 211 195 243 210 205 203 237 206 216 209 202 213 214 207 213 187 194] MW2[238 217 226 195 218 220 216 226 184 193 208 172 212 207 231 203 207 245 212 238 246 205 218 220 246 222 210 191 197 202 192 237 179 203 195 209 197 223 201 229 217 210 211 218 200 245 229 217 225 190 221 206 216 238 216 244 222 212 197 222 208 209 208 231 211 198 184 243 210 234 209 231 200 192 196 219 241 192 216 232 212 221 209 225 192 221 186 234 212 218 211 212 202 204 205 207 209 208 227 214 231 234 191 227 240 194 243 230 205 203 226 197 224 213] CRC[0 1 0] POW_I2C_CONN[SUCCES] HS_RCD0[Tenv:23 Tavg:65 Fan1:3407 Fan2:3407 V12:1217 Vout:1277 P_I:220 P_P:2809] HS_RCD1[Tenv:23 Tavg:65 Fan1:3272 Fan2:3320 V12:1217 Vout:1277 P_I:220 P_P:2809] HS_RCD2[Tenv:23 Tavg:65 Fan1:3280 Fan2:3316 V12:1217 Vout:1277 P_I:220 P_P:2813] HS_RCD3[Tenv:23 Tavg:66 Fan1:3369 Fan2:3273 V12:1217 Vout:1277 P_I:221 P_P:2826] HS_RCD4[Tenv:24 Tavg:66 Fan1:3448 Fan2:3340 V12:1217 Vout:1279 P_I:221 P_P:2834] MEMFREE[269880 B] FACOPTS0[] FACOPTS1[] WORKMODE[1],MM Count=1,Smart Speed=1,Connection Overloaded=false,Voltage Level Offset=0,Nonce Mask=25 |

## 附录一  电源返回值表

| **Value** | **Definition** | **Notes**              |
| --------- | -------------- | ---------------------- |
| 0         | OK             | 一切正常               |
| 1         | Input_UV       | 输入欠压（AV电不正常） |
| 2         | OT1            | 过温保护               |
| 4         | OT2            | 过温保护               |
| 8         | OT3            | 过温保护               |
| 16        | OC_Pri         | 原边过流               |
| 32        | UV_out         | 输出欠压               |
| 64        | OC_out         | 输出过流               |
| 128       | CS_error       | N/A                    |
| 256       | OC_IOSA        | N/A                    |
| 512       | OC_IOSB        | N/A                    |
| 1024      | OC_IOSC        | N/A                    |
| 2048      | FAN_error      | 风扇故障               |

 

## 附录二  Linux下socat工具安装方法

### 1.在RedHat，Fedora，CentOS这些Linux发行版上安装socat

​         确保您的linux系统可以连接互联网。如果您使用非root用户登录终端，需要确保您的用户在sudo授权列表中（可以联系操作系统管理员确认）。

​        在终端输入"sudo yum install socat"并回车，按提示输入登录密码，在后续的提示中全部选择yes或者输入y以完成安装。

### 2.Debian，Ubuntu，Kali这些Linux发行版上安装socat

​       确保您的linux系统可以连接互联网。如果您使用非root用户登录终端，需要确保您的用户在sudo授权列表中（可以联系操作系统管理员确认）。

​        在终端输入"sudo apt install socat"并回车，按提示输入登录密码，在后续的提示中全部选择yes或者输入y以完成安装。